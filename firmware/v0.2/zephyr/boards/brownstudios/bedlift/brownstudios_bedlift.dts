/dts-v1/;
#include <st/c0/stm32c031X6.dtsi>
#include <st/c0/stm32c031c(4-6)tx-pinctrl.dtsi>

/ {
	model = "Brown Studios Bed Lift board";
	compatible = "brownstudios,bedlift";

	chosen {
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		zephyr,console = &usart1;
		zephyr,shell-uart = &usart1;
	};

	zephyr,user {
		control-up-gpios = <&gpiob 8 GPIO_ACTIVE_LOW>;
		control-down-gpios = <&gpiob 9 GPIO_ACTIVE_LOW>;
	};

	indicator_status: indicator_status {
		compatible = "color-indicator";

		pwms = <&pwm1 1 PWM_USEC(500) PWM_POLARITY_NORMAL>,
			<&pwm1 2 PWM_USEC(500) PWM_POLARITY_NORMAL>,
			<&pwm1 3 PWM_USEC(500) PWM_POLARITY_NORMAL>;
	};
};

&clk_hsi {
	status = "okay";
};

&rcc {
	clocks = <&clk_hsi>;
	clock-frequency = <DT_FREQ_M(48)>;
	ahb-prescaler = <1>;
	apb1-prescaler = <4>;
};

&timers1 {
	st,prescaler = <0>;
	status = "okay";

	pwm1: pwm {
		pinctrl-0 = <&tim1_ch1_pa0>, <&tim1_ch2_pa1>, <&tim1_ch3_pa2>;
		pinctrl-names = "default";
		status = "okay";
	};
};

&timers14 {
	st,prescaler = <0>;
	status = "okay";

	span_step_counter: counter {
		status = "okay";
	};
};

&i2c1 {
	pinctrl-0 = <&i2c1_scl_pb6>, <&i2c1_sda_pb7>;
	pinctrl-names = "default";
	clock-frequency = <I2C_BITRATE_STANDARD>;
	status = "okay";
};

&spi1 {
	pinctrl-0 = <&spi1_sck_pa5>, <&spi1_miso_pa6>, <&spi1_mosi_pa7>;
	pinctrl-names = "default";
	clock-frequency = <DT_FREQ_M(1)>;
	cs-gpios = <&gpioc 15 GPIO_ACTIVE_LOW>;
	status = "okay";

	span_step_driver: spi-device@0 {
		compatible = "ti,drv8434s";

		status = "okay";
		reg = <0>;
		spi-max-frequency = <10000000>; /* datasheet maximum: 10 MHz */
		/* TODO: These will be needed for Zephyr 4.3, PIO currently has Zephyr 4.2.1.
		spi-cs-setup-delay-ns = <50>;
		spi-cs-hold-delay-ns = <50>;
		*/

		num-devices = <4>;
		fault-gpios = <&gpioa 4 GPIO_ACTIVE_LOW>;
		sleep-gpios = <&gpioa 3 GPIO_ACTIVE_LOW>;

		/* Average current measurements for different values at 1000 steps / second
		 *
		 *   4: 1.7 A
		 *   5: 1.4 A, circuit board very hot under the chip
		 *   6: 1.2 A
		 *   7: 1.0 A
		 */
		trq-dac = <7>;
	};
};

&usart1 {
	pinctrl-0 = <&usart1_tx_pa9>, <&usart1_rx_pa10>;
	pinctrl-names = "default";
	current-speed = <115200>;
	/* status = "okay"; */
};
